---
/**
 * Componente ContactForm - InnovaTec
 * 
 * Formulario de contacto con validación, honeypot y rate limiting.
 * 
 * Principios aplicados:
 * - Single Responsibility: Formulario de contacto único
 * - Separation of Concerns: Validación separada del UI
 */

import Button from '@/components/ui/Button.astro';

// Cargar traducciones
const pagesEs = await import('@/locales/es/pages.json');
const pagesEn = await import('@/locales/en/pages.json');

// Leer cookie del idioma en el servidor
const localeCookie = Astro.cookies.get('innovatac-locale');
const serverLocale = (localeCookie?.value === 'es' || localeCookie?.value === 'en') 
  ? localeCookie.value as 'es' | 'en'
  : 'es';

const currentLocale = serverLocale;
const translations = currentLocale === 'es' ? pagesEs.default : pagesEn.default;
---

<form
  id="contact-form"
  class="space-y-6"
  novalidate
  aria-label={translations.contact.form.send}
  data-locale={currentLocale}
>
  <!-- Campo nombre -->
  <div>
    <label
      for="contact-name"
      class="block text-sm font-medium text-light-text-primary dark:text-white mb-2"
    >
      {translations.contact.form.name}
      <span class="text-error" aria-label="requerido">*</span>
    </label>
    <input
      type="text"
      id="contact-name"
      name="name"
      required
      minlength="2"
      maxlength="100"
      autocomplete="name"
      class="w-full px-4 py-2 text-base text-light-text-primary dark:text-white bg-light-bg-primary dark:bg-dark-bg-primary border border-light-border dark:border-[#1a1a1a] rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors"
      aria-describedby="name-error"
    />
    <p id="name-error" class="mt-1 text-sm text-error hidden" role="alert"></p>
  </div>

  <!-- Campo email -->
  <div>
    <label
      for="contact-email"
      class="block text-sm font-medium text-light-text-primary dark:text-white mb-2"
    >
      {translations.contact.form.email}
      <span class="text-error" aria-label="requerido">*</span>
    </label>
    <input
      type="email"
      id="contact-email"
      name="email"
      required
      minlength="5"
      maxlength="255"
      autocomplete="email"
      class="w-full px-4 py-2 text-base text-light-text-primary dark:text-white bg-light-bg-primary dark:bg-dark-bg-primary border border-light-border dark:border-[#1a1a1a] rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors"
      aria-describedby="email-error"
    />
    <p id="email-error" class="mt-1 text-sm text-error hidden" role="alert"></p>
  </div>

  <!-- Campo mensaje -->
  <div>
    <label
      for="contact-message"
      class="block text-sm font-medium text-light-text-primary dark:text-white mb-2"
    >
      {translations.contact.form.message}
      <span class="text-error" aria-label="requerido">*</span>
    </label>
    <textarea
      id="contact-message"
      name="message"
      required
      minlength="10"
      maxlength="2000"
      rows="6"
      class="w-full px-4 py-2 text-base text-light-text-primary dark:text-dark-text-primary bg-light-bg-primary dark:bg-dark-bg-primary border border-light-border dark:border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors resize-y"
      aria-describedby="message-error"
    ></textarea>
    <p id="message-error" class="mt-1 text-sm text-error hidden" role="alert"></p>
  </div>

  <!-- Honeypot field (oculto para humanos, visible para bots) -->
  <div class="sr-only" aria-hidden="true">
    <label for="contact-website">No completar este campo</label>
    <input
      type="text"
      id="contact-website"
      name="website"
      tabindex="-1"
      autocomplete="off"
    />
  </div>

  <!-- Mensaje de éxito/error -->
  <div
    id="form-message"
    class="hidden p-4 rounded-lg"
    role="alert"
    aria-live="polite"
  ></div>

  <!-- Botón de envío -->
  <div>
    <Button type="submit" variant="primary" size="lg" class="w-full sm:w-auto">
      <span id="submit-text">{translations.contact.form.send}</span>
      <span id="submit-loading" class="hidden">
        {translations.contact.form.sending}
      </span>
    </Button>
  </div>
</form>

<script>
        import { validateContactForm, sanitizeContactForm } from '@/lib/validators';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text');
  const submitLoading = document.getElementById('submit-loading');
  const formMessage = document.getElementById('form-message');

  // Obtener traducciones según el locale
  const locale = form?.getAttribute('data-locale') || 'es';
  const translations = {
    es: {
      rateLimit: 'Has enviado demasiados mensajes. Por favor, esperá un momento antes de intentar nuevamente.',
      spamDetected: 'Spam detectado. El mensaje no fue enviado.',
      success: '¡Mensaje enviado! Te contactaré pronto.',
      error: 'Error al enviar el mensaje. Por favor, intentá nuevamente.',
      connectionError: 'Error de conexión. Por favor, intentá nuevamente más tarde.',
    },
    en: {
      rateLimit: 'You have sent too many messages. Please wait a moment before trying again.',
      spamDetected: 'Spam detected. The message was not sent.',
      success: 'Message sent! I\'ll contact you soon.',
      error: 'Error sending message. Please try again.',
      connectionError: 'Connection error. Please try again later.',
    },
  };
  const t = translations[locale as 'es' | 'en'] || translations.es;

  // Rate limiting básico (localStorage)
  const RATE_LIMIT_KEY = 'innovatac-contact-rate-limit';
  const RATE_LIMIT_MAX = 3; // Máximo 3 envíos
  const RATE_LIMIT_WINDOW = 60 * 60 * 1000; // 1 hora

  function checkRateLimit(): boolean {
    if (typeof window === 'undefined') return true;

    try {
      const stored = localStorage.getItem(RATE_LIMIT_KEY);
      if (!stored) {
        localStorage.setItem(
          RATE_LIMIT_KEY,
          JSON.stringify({ count: 0, resetTime: Date.now() + RATE_LIMIT_WINDOW })
        );
        return true;
      }

      const data = JSON.parse(stored);
      const now = Date.now();

      // Resetear si pasó la ventana de tiempo
      if (now > data.resetTime) {
        localStorage.setItem(
          RATE_LIMIT_KEY,
          JSON.stringify({ count: 0, resetTime: now + RATE_LIMIT_WINDOW })
        );
        return true;
      }

      // Verificar límite
      if (data.count >= RATE_LIMIT_MAX) {
        return false;
      }

      return true;
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('Error checking rate limit:', error);
      }
      return true; // Permitir en caso de error
    }
  }

  function incrementRateLimit(): void {
    if (typeof window === 'undefined') return;

    try {
      const stored = localStorage.getItem(RATE_LIMIT_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        data.count = (data.count || 0) + 1;
        localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(data));
      }
    } catch (error) {
      if (import.meta.env.DEV) {
        console.warn('Error incrementing rate limit:', error);
      }
    }
  }

  function showMessage(message: string, isError: boolean = false): void {
    if (!formMessage) return;

    formMessage.textContent = message;
    formMessage.classList.remove('hidden');
    formMessage.classList.remove(
      isError ? 'bg-accent-light' : 'bg-error',
      isError ? 'text-error' : 'text-accent'
    );
    formMessage.classList.add(
      isError ? 'bg-error/10' : 'bg-accent-light',
      isError ? 'text-error' : 'text-accent'
    );

    // Ocultar después de 5 segundos
    setTimeout(() => {
      formMessage.classList.add('hidden');
    }, 5000);
  }

  function clearErrors(): void {
    const errorElements = form?.querySelectorAll('[role="alert"]');
    errorElements?.forEach((el) => {
      if (el.id.includes('-error')) {
        el.classList.add('hidden');
        el.textContent = '';
      }
    });
  }

  function showFieldError(fieldId: string, message: string): void {
    const errorElement = document.getElementById(`${fieldId}-error`);
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }
  }

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();

      // Verificar rate limiting
      if (!checkRateLimit()) {
        showMessage(t.rateLimit, true);
        return;
      }

      // Obtener datos del formulario
      const formData = new FormData(form);
      const data = {
        name: formData.get('name') as string,
        email: formData.get('email') as string,
        message: formData.get('message') as string,
        website: formData.get('website') as string, // Honeypot
      };

      // Validar con Zod
      const validation = validateContactForm(data);

      if (!validation.success || !validation.data) {
        // Mostrar errores de validación
        if (validation.errors) {
          validation.errors.errors.forEach((error: { path: (string | number)[]; message: string }) => {
            const fieldName = error.path[0] as string;
            if (fieldName === 'name') {
              showFieldError('contact-name', error.message);
            } else if (fieldName === 'email') {
              showFieldError('contact-email', error.message);
            } else if (fieldName === 'message') {
              showFieldError('contact-message', error.message);
            } else if (fieldName === 'website' && data.website) {
              // Honeypot detectado
              showMessage(t.spamDetected, true);
              return;
            }
          });
        }
        return;
      }

      // Sanitizar datos
      const sanitizedData = sanitizeContactForm(validation.data);

      // Deshabilitar botón y mostrar loading
      if (submitButton) submitButton.disabled = true;
      if (submitText) submitText.classList.add('hidden');
      if (submitLoading) submitLoading.classList.remove('hidden');

      try {
        // Enviar email a través del endpoint de la API
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: sanitizedData.name,
            email: sanitizedData.email,
            message: sanitizedData.message,
            website: '', // Honeypot (vacío)
          }),
        });

        const result = await response.json();

        if (result.success) {
          showMessage(t.success, false);
          form.reset();
          incrementRateLimit();
        } else {
          showMessage(result.error || t.error, true);
        }
      } catch (error) {
        if (import.meta.env.DEV) {
          console.error('Error sending email:', error);
        }
        showMessage(t.connectionError, true);
      } finally {
        // Rehabilitar botón
        if (submitButton) submitButton.disabled = false;
        if (submitText) submitText.classList.remove('hidden');
        if (submitLoading) submitLoading.classList.add('hidden');
      }
    });
  }
</script>

